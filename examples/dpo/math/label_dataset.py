"""
Label the dataset generated by models
"""

# import rule-based grader

from verl.utils.reward_score import gsm8k
import pandas as pd
import numpy as np

if __name__ == '__main__':
    dataset = pd.read_parquet('/mnt/bn/seed-rlhf-hl/zhangchi.usc1992/data/gsm8k/Qwen2.5-3B-Instruct_output.parquet')

    # for each data item, we rank the responses using rule-based RM
    ranks = []

    for idx, row in dataset.iterrows():
        responses = row['responses']
        ground_truth = row['reward_model']['ground_truth']
        scores = []

        for response in responses:
            score = gsm8k.compute_score(response, ground_truth=ground_truth)
            scores.append(score)
        
        # produce a ranking order. from lower to higher
        sorted_idx = np.argsort(scores)
        ranks.append(sorted_idx)

    dataset['ranks'] = ranks

    dataset.to_parquet('/mnt/bn/seed-rlhf-hl/zhangchi.usc1992/data/gsm8k/Qwen2.5-3B-Instruct_output_after_ranking.parquet')

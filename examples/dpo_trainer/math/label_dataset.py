"""
Label the dataset generated by models
"""

# import rule-based grader

from verl.utils.reward_score import gsm8k
import pandas as pd
import numpy as np

if __name__ == '__main__':
    import argparse
    parser  = argparse.ArgumentParser()
    parser.add_argument('--input_file', required=True, type=str)
    parser.add_argument('--output_file', required=True, type=str)

    args = parser.parse_args()

    dataset = pd.read_parquet(args.input_file)

    # for each data item, we rank the responses using rule-based RM
    ranks = []

    for idx, row in dataset.iterrows():
        responses = row['responses']
        ground_truth = row['reward_model']['ground_truth']
        scores = []

        for response in responses:
            score = gsm8k.compute_score(response, ground_truth=ground_truth)
            scores.append(score)
        
        # produce a ranking order. from lower to higher
        sorted_idx = np.argsort(scores)
        ranks.append(sorted_idx)

    dataset['ranks'] = ranks

    dataset.to_parquet(args.output_file)
